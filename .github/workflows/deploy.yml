name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            set -e  # Exit on any error

            # Navigate to project directory
            cd /var/www/inspirtag

            # FORCE reset to GitHub version (prevents merge conflicts)
            echo "üîÑ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd

            # Make scripts executable if they exist
            chmod +x docker/entrypoint.sh 2>/dev/null || true
            chmod +x *.sh 2>/dev/null || true

            # Check if Docker is running
            if ! docker info > /dev/null 2>&1; then
              echo "üê≥ Starting Docker..."
              sudo systemctl start docker
              sleep 5
            fi

            # ============================================
            # NGINX REVERSE PROXY SETUP (AUTOMATED)
            # ============================================
            echo "üîß Setting up Nginx Reverse Proxy..."

            # Stop system nginx temporarily if needed for SSL
            NGINX_STOPPED=false
            if systemctl is-active --quiet nginx 2>/dev/null; then
              echo "   System nginx is running"
            fi

            # Find nginx config directory
            if [ -d "/etc/nginx/conf.d" ]; then
              NGINX_CONFIG_DIR="/etc/nginx/conf.d"
              NGINX_CONFIG_FILE="/etc/nginx/conf.d/api.inspirtag.com.conf"
              echo "   Using /etc/nginx/conf.d (CentOS/RHEL style)"
            elif [ -d "/etc/nginx/sites-available" ]; then
              NGINX_CONFIG_DIR="/etc/nginx/sites-available"
              NGINX_CONFIG_FILE="/etc/nginx/sites-available/api.inspirtag.com.conf"
              echo "   Using /etc/nginx/sites-available (Debian/Ubuntu style)"
            else
              # Create sites-available structure
              sudo mkdir -p /etc/nginx/sites-available
              sudo mkdir -p /etc/nginx/sites-enabled
              NGINX_CONFIG_DIR="/etc/nginx/sites-available"
              NGINX_CONFIG_FILE="/etc/nginx/sites-available/api.inspirtag.com.conf"
              echo "   Created sites-available directory"

              # Find main nginx config file
              NGINX_MAIN_CONF=""
              for conf_file in /etc/nginx/nginx.conf /usr/local/nginx/conf/nginx.conf /opt/nginx/conf/nginx.conf; do
                if [ -f "$conf_file" ]; then
                  NGINX_MAIN_CONF="$conf_file"
                  break
                fi
              done

              # If nginx.conf exists, add include for sites-enabled
              if [ -n "$NGINX_MAIN_CONF" ]; then
                if ! grep -q "sites-enabled" "$NGINX_MAIN_CONF" 2>/dev/null; then
                  echo "   Adding sites-enabled to main nginx config: $NGINX_MAIN_CONF"
                  # Try to add after http { block
                  sudo sed -i '/^http {/a\    include /etc/nginx/sites-enabled/*;' "$NGINX_MAIN_CONF" 2>/dev/null || {
                    # If that fails, try adding at end of http block
                    echo "   Adding include at end of http block..."
                    sudo sed -i '/^}$/i\    include /etc/nginx/sites-enabled/*;' "$NGINX_MAIN_CONF" 2>/dev/null || true
                  }
                fi
              else
                echo "   ‚ö†Ô∏è Main nginx.conf not found - using conf.d approach instead"
                NGINX_CONFIG_DIR="/etc/nginx/conf.d"
                sudo mkdir -p "$NGINX_CONFIG_DIR"
                NGINX_CONFIG_FILE="/etc/nginx/conf.d/api.inspirtag.com.conf"
              fi
            fi

            # Copy nginx config if it exists in project
            if [ -f "api.inspirtag.com.conf" ] || [ -f "system-nginx-api-inspirtag.conf" ]; then
              CONFIG_SOURCE="api.inspirtag.com.conf"
              [ ! -f "$CONFIG_SOURCE" ] && CONFIG_SOURCE="system-nginx-api-inspirtag.conf"

              echo "   Copying nginx configuration..."
              sudo cp "$CONFIG_SOURCE" "$NGINX_CONFIG_FILE"

              # If using sites-available, create symlink
              if [ "$NGINX_CONFIG_DIR" = "/etc/nginx/sites-available" ]; then
                sudo ln -sf "$NGINX_CONFIG_FILE" /etc/nginx/sites-enabled/api.inspirtag.com.conf
              fi
            else
              # Generate nginx config dynamically
              echo "   Generating nginx configuration..."
              cat > /tmp/nginx_config_temp.conf << 'NGINX_CONFIG_EOF'
            # HTTP - redirect to HTTPS
            server {
                listen 80;
                server_name api.inspirtag.com;

                location /.well-known/acme-challenge/ {
                    root /var/www/html;
                }

                location / {
                    return 301 https://$server_name$request_uri;
                }
            }

            # HTTPS - proxy to Docker nginx
            server {
                listen 443 ssl http2;
                server_name api.inspirtag.com;

                ssl_certificate /etc/letsencrypt/live/api.inspirtag.com/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/api.inspirtag.com/privkey.pem;

                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers HIGH:!aNULL:!MD5;
                ssl_prefer_server_ciphers on;

                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                client_max_body_size 50M;

                location / {
                    proxy_pass http://127.0.0.1:8080;
                    proxy_redirect off;
                }
            }
            NGINX_CONFIG_EOF
              sudo mv /tmp/nginx_config_temp.conf "$NGINX_CONFIG_FILE"

              if [ "$NGINX_CONFIG_DIR" = "/etc/nginx/sites-available" ]; then
                sudo ln -sf "$NGINX_CONFIG_FILE" /etc/nginx/sites-enabled/api.inspirtag.com.conf
              fi
            fi

            # Generate SSL certificate if it doesn't exist
            if [ ! -f "/etc/letsencrypt/live/api.inspirtag.com/fullchain.pem" ]; then
              echo "üîê Generating SSL certificate..."

              # Install certbot if not installed
              if ! command -v certbot &> /dev/null; then
                echo "   Installing certbot..."
                sudo apt update -qq
                sudo apt install -y certbot
              fi

              # Stop services using port 80 for certificate generation
              echo "   Stopping services on port 80..."

              # Kill any existing certbot processes
              echo "   Checking for existing certbot processes..."
              sudo pkill -f certbot 2>/dev/null || true
              sleep 2

              # Stop Docker nginx (using port 80)
              echo "   Stopping Docker nginx..."
              docker-compose stop nginx 2>/dev/null || true

              # Stop system nginx if it exists and is running
              if systemctl is-active --quiet nginx 2>/dev/null; then
                echo "   Stopping system nginx..."
                sudo systemctl stop nginx
                NGINX_STOPPED=true
              fi

              # Find and stop any process using port 80
              echo "   Checking for processes on port 80..."
              PORT_80_PID=$(sudo lsof -ti:80 2>/dev/null || echo "")
              if [ -n "$PORT_80_PID" ]; then
                echo "   Found process $PORT_80_PID using port 80"
                echo "   Stopping process..."
                sudo kill -9 $PORT_80_PID 2>/dev/null || true
                sleep 2
              fi

              # Verify port 80 is free
              if sudo lsof -ti:80 > /dev/null 2>&1; then
                echo "   ‚ö†Ô∏è Port 80 is still in use, listing processes:"
                sudo lsof -i:80 || sudo netstat -tulpn | grep :80
                echo "   Attempting to free port 80..."
                sudo fuser -k 80/tcp 2>/dev/null || true
                sleep 2
              fi

              # Generate certificate
              echo "   Generating certificate..."
              sudo certbot certonly --standalone \
                -d api.inspirtag.com \
                --email admin@inspirtag.com \
                --agree-tos \
                --non-interactive || {
                echo "‚ö†Ô∏è SSL certificate generation failed"
                echo "   This might be because:"
                echo "   - Port 80 is still in use"
                echo "   - DNS is not fully propagated"
                echo "   - Rate limit reached"
                echo "   - Another certbot instance is running"
                echo "   Continuing without SSL - you can generate it manually later"
              }

              # Restart Docker nginx
              echo "   Restarting Docker nginx..."
              docker-compose start nginx 2>/dev/null || docker-compose up -d nginx 2>/dev/null || true

              # Start system nginx if we stopped it
              if [ "$NGINX_STOPPED" = true ]; then
                sudo systemctl start nginx 2>/dev/null || true
              fi
            else
              echo "‚úÖ SSL certificate already exists"
            fi

            # Test nginx configuration
            echo "üß™ Testing nginx configuration..."
            if command -v nginx &> /dev/null; then
              if sudo nginx -t 2>/dev/null; then
                echo "‚úÖ Nginx configuration is valid"
                echo "   Reloading system nginx..."
                sudo systemctl reload nginx 2>/dev/null || {
                  echo "   Reload failed, trying restart..."
                  sudo systemctl restart nginx 2>/dev/null || sudo systemctl start nginx 2>/dev/null || true
                }
                sleep 3
                echo "   System nginx status:"
                sudo systemctl status nginx --no-pager -l | head -5
              else
                echo "‚ö†Ô∏è Nginx configuration has errors"
                echo "   Error output:"
                sudo nginx -t 2>&1
                echo "   Continuing anyway..."
              fi
            else
              echo "‚ö†Ô∏è Nginx command not found - skipping nginx setup"
              echo "   You may need to install nginx or configure manually"
            fi

            # ============================================
            # DOCKER SETUP
            # ============================================

            # Check if system nginx exists and is configured
            SYSTEM_NGINX_EXISTS=false
            if command -v nginx &> /dev/null; then
              SYSTEM_NGINX_EXISTS=true
              echo "‚úÖ System nginx is installed"
            fi

            # Configure Docker ports based on system nginx availability
            echo "üîß Configuring Docker ports..."
            if [ "$SYSTEM_NGINX_EXISTS" = true ]; then
              # Use port 8080 if system nginx exists
              echo "   System nginx detected - using port 8080 for Docker"
              if grep -q '"80:80"' docker-compose.yml; then
                echo "   Updating docker-compose.yml to use port 8080..."
                sed -i 's/"80:80"/"8080:80"/' docker-compose.yml
                sed -i 's/"443:443"/# "443:443"  # Removed - system nginx handles SSL/' docker-compose.yml
              fi

              # Update nginx config to use HTTP-only
              if grep -q "nginx-ssl.conf" docker-compose.yml; then
                echo "   Updating to use HTTP-only nginx config..."
                sed -i 's|nginx-ssl.conf|nginx.conf|' docker-compose.yml
              fi
            else
              # No system nginx - use port 80 directly
              echo "   No system nginx - using port 80 directly for Docker"
              if grep -q '"8080:80"' docker-compose.yml; then
                echo "   Updating docker-compose.yml to use port 80..."
                sed -i 's/"8080:80"/"80:80"/' docker-compose.yml
              fi
            fi

            # Add missing .env variables if not present
            echo "üîß Ensuring .env has required variables..."
            grep -q "AWS_URL=" .env || echo "AWS_URL=" >> .env
            grep -q "AWS_ENDPOINT=" .env || echo "AWS_ENDPOINT=" >> .env
            grep -q "AWS_USE_PATH_STYLE_ENDPOINT=" .env || echo "AWS_USE_PATH_STYLE_ENDPOINT=false" >> .env
            grep -q "APP_URL=" .env || echo "APP_URL=https://api.inspirtag.com" >> .env
            grep -q "APP_ENV=" .env || echo "APP_ENV=production" >> .env

            # Fix DB_HOST for Linux
            echo "üîç Checking DB_HOST configuration..."
            if grep -q "^DB_HOST=host.docker.internal" .env; then
              echo "‚ö†Ô∏è Found host.docker.internal (doesn't work on Linux)"
              DOCKER_IP=$(ip addr show docker0 2>/dev/null | grep 'inet ' | awk '{print $2}' | cut -d/ -f1 || echo "172.17.0.1")
              sed -i "s|^DB_HOST=.*|DB_HOST=$DOCKER_IP|" .env
              echo "‚úÖ Updated DB_HOST to $DOCKER_IP"
            fi

            if ! grep -q "^DB_HOST=" .env; then
              DOCKER_IP=$(ip addr show docker0 2>/dev/null | grep 'inet ' | awk '{print $2}' | cut -d/ -f1 || echo "172.17.0.1")
              echo "DB_HOST=$DOCKER_IP" >> .env
              echo "‚úÖ Added DB_HOST=$DOCKER_IP"
            fi

            # Backup .env file
            echo "üíæ Backing up .env file..."
            cp .env .env.backup

            # Complete shutdown - remove everything
            echo "üõë Stopping all containers..."
            docker-compose down --remove-orphans --timeout 10 || true

            # Force remove any stuck containers
            echo "üßπ Cleaning up stuck containers..."
            docker ps -aq | xargs -r docker rm -f 2>/dev/null || true

            # Prune everything
            docker container prune -f
            docker network prune -f

            # Ensure Docker network exists
            echo "üîß Ensuring Docker network exists..."
            docker network create inspirtag_inspirtag-network 2>/dev/null || true

            # Restore .env file
            echo "üìã Restoring .env file..."
            cp .env.backup .env

            # Always rebuild to ensure latest code
            echo "üî® Building containers..."
            docker-compose build --no-cache

            # Start all containers fresh
            echo "üöÄ Starting containers..."
            docker-compose up -d --force-recreate --remove-orphans

            # Wait for services to be ready
            echo "‚è≥ Waiting for services to start..."
            sleep 20

            # Check container status
            echo "üîç Container status:"
            docker-compose ps

            # Wait for containers to be healthy
            echo "‚è≥ Waiting for containers to be healthy..."
            MAX_RETRIES=30
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if docker-compose ps | grep -q "Up"; then
                echo "   ‚úÖ Containers are up"
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "   Waiting... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 2
            done

            # Check if app container is running
            echo "üîç Checking app container..."
            if ! docker-compose ps app | grep -q "Up"; then
              echo "‚ùå App container is not running"
              echo "   Attempting to start..."
              docker-compose up -d app
              sleep 10
              docker-compose logs --tail=50 app
              if ! docker-compose ps app | grep -q "Up"; then
                echo "‚ùå App container failed to start"
                exit 1
              fi
            fi

            # Check if nginx container is running
            echo "üîç Checking nginx container..."
            if ! docker-compose ps nginx | grep -q "Up"; then
              echo "‚ùå Nginx container is not running"
              echo "   Attempting to start..."
              docker-compose up -d nginx
              sleep 10
              docker-compose logs --tail=50 nginx
              if ! docker-compose ps nginx | grep -q "Up"; then
                echo "‚ùå Nginx container failed to start"
                echo "   This is critical - API will not be accessible"
              fi
            fi

            # Verify Docker nginx port is listening
            echo "üîç Verifying Docker nginx port..."
            sleep 5
            if [ "$SYSTEM_NGINX_EXISTS" = true ]; then
              # Check port 8080
              if netstat -tuln 2>/dev/null | grep -q ":8080 " || ss -tuln 2>/dev/null | grep -q ":8080 "; then
                echo "   ‚úÖ Port 8080 is listening"
              else
                echo "   ‚ùå Port 8080 is NOT listening"
                echo "   Restarting nginx container..."
                docker-compose restart nginx
                sleep 10
              fi
            else
              # Check port 80
              if netstat -tuln 2>/dev/null | grep -q ":80 " || ss -tuln 2>/dev/null | grep -q ":80 "; then
                echo "   ‚úÖ Port 80 is listening"
              else
                echo "   ‚ùå Port 80 is NOT listening"
                echo "   Restarting nginx container..."
                docker-compose restart nginx
                sleep 10
              fi
            fi

            # Clear all Laravel caches
            echo "üßπ Clearing Laravel caches..."
            docker-compose exec -T app php artisan config:clear || true
            docker-compose exec -T app php artisan route:clear || true
            docker-compose exec -T app php artisan cache:clear || true
            docker-compose exec -T app php artisan view:clear || true
            docker-compose exec -T app rm -rf bootstrap/cache/*.php || true

            # Run migrations
            echo "üóÑÔ∏è Running migrations..."
            docker-compose exec -T app php artisan migrate --force || {
              echo "‚ö†Ô∏è Migrations failed, continuing..."
            }

            # Cache configuration
            echo "üì¶ Caching configuration..."
            docker-compose exec -T app php artisan config:cache
            docker-compose exec -T app php artisan route:cache
            docker-compose exec -T app php artisan view:cache

            # Restart queue workers
            echo "üîÑ Restarting queue workers..."
            docker-compose exec -T app php artisan queue:restart || true

            # Health check
            echo "üè• Health check..."
            sleep 10

            # Test Docker nginx directly
            DOCKER_PORT="8080"
            if [ "$SYSTEM_NGINX_EXISTS" != true ]; then
              DOCKER_PORT="80"
            fi

            echo "üîç Testing Docker nginx on port $DOCKER_PORT..."
            echo "   Testing /health endpoint..."
            if curl -f http://localhost:$DOCKER_PORT/health > /dev/null 2>&1; then
              echo "‚úÖ /health endpoint working"
              curl -s http://localhost:$DOCKER_PORT/health
            else
              echo "‚ö†Ô∏è /health endpoint failed"
              echo "   Checking if nginx container is running..."
              docker-compose ps nginx
              if ! docker-compose ps nginx | grep -q "Up"; then
                echo "   ‚ùå Nginx container is down - restarting..."
                docker-compose up -d nginx
                sleep 10
              fi
            fi

            echo ""
            echo "   Testing /api/health endpoint..."
            if curl -f http://localhost:$DOCKER_PORT/api/health > /dev/null 2>&1; then
              echo "‚úÖ /api/health endpoint working"
              curl -s http://localhost:$DOCKER_PORT/api/health | head -3
            else
              echo "‚ùå /api/health endpoint failed"
              echo "   Checking nginx container..."
              docker-compose ps nginx
              echo "   Nginx logs:"
              docker-compose logs --tail=50 nginx
              echo "   App logs:"
              docker-compose logs --tail=30 app
              echo "   Testing app container directly..."
              docker-compose exec -T app php artisan route:list | grep health || echo "   Cannot access app container"
            fi

            echo ""
            echo "   Testing /api/categories endpoint..."
            if curl -f http://localhost:$DOCKER_PORT/api/categories > /dev/null 2>&1; then
              echo "‚úÖ API endpoint working"
            else
              echo "‚ö†Ô∏è API endpoint test failed"
            fi

            # Critical check - if Docker port is not accessible, API won't work
            echo ""
            echo "üîç Critical check - Port $DOCKER_PORT accessibility..."
            if curl -f http://127.0.0.1:$DOCKER_PORT/api/health > /dev/null 2>&1; then
              echo "‚úÖ Port $DOCKER_PORT is accessible from localhost"
            else
              echo "‚ùå CRITICAL: Port $DOCKER_PORT is NOT accessible"
              echo "   This means the API will not work!"
              echo "   Checking firewall..."
              sudo ufw status 2>/dev/null || sudo iptables -L -n | grep $DOCKER_PORT || echo "   Firewall check failed"
              echo "   Attempting emergency restart..."
              docker-compose restart nginx
              sleep 15
              echo "   Testing again..."
              if curl -f http://127.0.0.1:$DOCKER_PORT/api/health > /dev/null 2>&1; then
                echo "   ‚úÖ Port $DOCKER_PORT is now accessible"
              else
                echo "   ‚ùå Port $DOCKER_PORT is still not accessible"
                echo "   Checking container logs..."
                docker-compose logs --tail=30 nginx
              fi
            fi

            # Check system nginx status
            echo ""
            echo "üîç Checking system nginx..."
            if command -v nginx &> /dev/null; then
              if systemctl is-active --quiet nginx 2>/dev/null; then
                echo "‚úÖ System nginx is running"
                sudo nginx -t 2>&1 | head -5
              else
                echo "‚ö†Ô∏è System nginx is not running"
                if systemctl list-units --type=service 2>/dev/null | grep -q nginx.service; then
                  echo "   Attempting to start system nginx..."
                  sudo systemctl start nginx 2>/dev/null || echo "   Failed to start"
                else
                  echo "   System nginx service not found"
                  echo "   ‚ö†Ô∏è System nginx may not be installed as a service"
                  echo "   API will only work via Docker nginx on port 8080"
                  echo "   To enable HTTPS, install and configure system nginx"
                fi
              fi
            else
              echo "‚ö†Ô∏è Nginx command not found"
              echo "   System nginx is not installed"
              echo "   API will work via Docker nginx on port 8080"
              echo "   For HTTPS, you need to install system nginx"
            fi

            # Check if nginx config exists
            echo ""
            echo "üîç Checking nginx configuration..."
            if [ -f "/etc/nginx/conf.d/api.inspirtag.com.conf" ]; then
              echo "‚úÖ Found: /etc/nginx/conf.d/api.inspirtag.com.conf"
            elif [ -f "/etc/nginx/sites-available/api.inspirtag.com.conf" ]; then
              echo "‚úÖ Found: /etc/nginx/sites-available/api.inspirtag.com.conf"
            else
              echo "‚ö†Ô∏è Nginx config file not found"
            fi

            # Test through system nginx (if SSL is configured)
            echo ""
            echo "üîç Testing HTTPS endpoint (api.inspirtag.com)..."
            if [ -f "/etc/letsencrypt/live/api.inspirtag.com/fullchain.pem" ]; then
              echo "‚úÖ SSL certificate exists"

              # Test HTTPS health endpoint
              echo "   Testing https://api.inspirtag.com/health..."
              if curl -f -k https://api.inspirtag.com/health > /dev/null 2>&1; then
                echo "‚úÖ HTTPS /health working"
                curl -s -k https://api.inspirtag.com/health
              else
                echo "‚ö†Ô∏è HTTPS /health failed"
              fi

              echo ""
              echo "   Testing https://api.inspirtag.com/api/health..."
              if curl -f -k https://api.inspirtag.com/api/health > /dev/null 2>&1; then
                echo "‚úÖ HTTPS /api/health working"
                curl -s -k https://api.inspirtag.com/api/health | head -3
              else
                echo "‚ö†Ô∏è HTTPS /api/health failed"
              fi

              echo ""
              echo "   Testing https://api.inspirtag.com/api/categories..."
              if curl -f -k https://api.inspirtag.com/api/categories > /dev/null 2>&1; then
                echo "‚úÖ HTTPS API endpoint working"
              else
                echo "‚ö†Ô∏è HTTPS API endpoint failed"
              fi

              # If HTTPS fails, do diagnostics
              if ! curl -f -k https://api.inspirtag.com/health > /dev/null 2>&1; then
                echo ""
                echo "   üîç Diagnosing HTTPS issues..."
                echo "   Testing DNS resolution..."
                nslookup api.inspirtag.com 2>&1 | head -5 || dig api.inspirtag.com 2>&1 | head -5 || echo "   DNS check failed"
                echo "   Testing HTTP (should redirect to HTTPS)..."
                curl -I http://api.inspirtag.com/health 2>&1 | head -5
                echo "   Testing localhost through system nginx..."
                curl -k https://localhost/health 2>&1 | head -5 || echo "   Localhost test failed"
                echo "   Checking system nginx error log..."
                sudo tail -10 /var/log/nginx/error.log 2>/dev/null || echo "   Cannot read error log"
              fi
            else
              echo "‚ö†Ô∏è SSL certificate not found"
              echo "   Run: sudo certbot certonly --standalone -d api.inspirtag.com"
              echo "   Testing HTTP endpoint (without SSL)..."
              if curl -f http://api.inspirtag.com/health > /dev/null 2>&1; then
                echo "‚úÖ HTTP endpoint working (SSL not configured yet)"
              else
                echo "‚ö†Ô∏è HTTP endpoint also failed"
                echo "   Testing DNS..."
                nslookup api.inspirtag.com 2>&1 | head -5 || dig api.inspirtag.com 2>&1 | head -5
              fi
            fi

            # Check port 8080 is accessible
            echo ""
            echo "üîç Checking port 8080..."
            if netstat -tuln 2>/dev/null | grep -q ":8080 " || ss -tuln 2>/dev/null | grep -q ":8080 "; then
              echo "‚úÖ Port 8080 is listening"
            else
              echo "‚ö†Ô∏è Port 8080 is not listening"
            fi

            # Final container status
            echo ""
            echo "üìä Final container status:"
            docker-compose ps

            echo ""
            echo "üìã Deployment Summary:"
            echo "   Docker nginx: $(docker-compose ps nginx | grep -q 'Up' && echo '‚úÖ Running' || echo '‚ùå Not running')"
            echo "   Docker app: $(docker-compose ps app | grep -q 'Up' && echo '‚úÖ Running' || echo '‚ùå Not running')"
            echo "   System nginx: $(systemctl is-active --quiet nginx 2>/dev/null && echo '‚úÖ Running' || echo '‚ö†Ô∏è Not running')"
            echo "   Port 8080: $(netstat -tuln 2>/dev/null | grep -q ':8080 ' && echo '‚úÖ Listening' || echo '‚ö†Ô∏è Not listening')"
            if [ -f "/etc/letsencrypt/live/api.inspirtag.com/fullchain.pem" ]; then
              echo "   SSL certificate: ‚úÖ Configured"
            else
              echo "   SSL certificate: ‚ö†Ô∏è Not configured"
            fi
            echo "   üìç API URL: https://api.inspirtag.com"

            echo ""
            echo "üîß Troubleshooting commands:"
            echo "   Check Docker: docker-compose ps && docker-compose logs"
            echo "   Check system nginx: sudo systemctl status nginx && sudo nginx -t"
            echo "   Test locally: curl http://localhost:8080/health"
            echo "   Test DNS: nslookup api.inspirtag.com"
            echo "   Check nginx config: ls -la /etc/nginx/conf.d/ /etc/nginx/sites-available/ 2>/dev/null"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
