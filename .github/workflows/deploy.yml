name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            set -e  # Exit on any error

            # Navigate to project directory
            cd /var/www/inspirtag

            # FORCE reset to GitHub version (prevents merge conflicts)
            echo "ğŸ”„ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd

            # Make scripts executable if they exist
            chmod +x docker/entrypoint.sh 2>/dev/null || true
            chmod +x *.sh 2>/dev/null || true

            # Check if Docker is running
            if ! docker info > /dev/null 2>&1; then
              echo "ğŸ³ Starting Docker..."
              sudo systemctl start docker
              sleep 5
            fi

            # ============================================
            # NGINX REVERSE PROXY SETUP (AUTOMATED)
            # ============================================
            echo "ğŸ”§ Setting up Nginx Reverse Proxy..."

            # Stop system nginx temporarily if needed for SSL
            NGINX_STOPPED=false
            if systemctl is-active --quiet nginx 2>/dev/null; then
              echo "   System nginx is running"
            fi

            # Find nginx config directory
            if [ -d "/etc/nginx/conf.d" ]; then
              NGINX_CONFIG_DIR="/etc/nginx/conf.d"
              NGINX_CONFIG_FILE="/etc/nginx/conf.d/api.inspirtag.com.conf"
              echo "   Using /etc/nginx/conf.d (CentOS/RHEL style)"
            elif [ -d "/etc/nginx/sites-available" ]; then
              NGINX_CONFIG_DIR="/etc/nginx/sites-available"
              NGINX_CONFIG_FILE="/etc/nginx/sites-available/api.inspirtag.com.conf"
              echo "   Using /etc/nginx/sites-available (Debian/Ubuntu style)"
            else
              # Create sites-available structure
              sudo mkdir -p /etc/nginx/sites-available
              sudo mkdir -p /etc/nginx/sites-enabled
              NGINX_CONFIG_DIR="/etc/nginx/sites-available"
              NGINX_CONFIG_FILE="/etc/nginx/sites-available/api.inspirtag.com.conf"
              echo "   Created sites-available directory"

              # Find main nginx config file
              NGINX_MAIN_CONF=""
              for conf_file in /etc/nginx/nginx.conf /usr/local/nginx/conf/nginx.conf /opt/nginx/conf/nginx.conf; do
                if [ -f "$conf_file" ]; then
                  NGINX_MAIN_CONF="$conf_file"
                  break
                fi
              done

              # If nginx.conf exists, add include for sites-enabled
              if [ -n "$NGINX_MAIN_CONF" ]; then
                if ! grep -q "sites-enabled" "$NGINX_MAIN_CONF" 2>/dev/null; then
                  echo "   Adding sites-enabled to main nginx config: $NGINX_MAIN_CONF"
                  # Try to add after http { block
                  sudo sed -i '/^http {/a\    include /etc/nginx/sites-enabled/*;' "$NGINX_MAIN_CONF" 2>/dev/null || {
                    # If that fails, try adding at end of http block
                    echo "   Adding include at end of http block..."
                    sudo sed -i '/^}$/i\    include /etc/nginx/sites-enabled/*;' "$NGINX_MAIN_CONF" 2>/dev/null || true
                  }
                fi
              else
                echo "   âš ï¸ Main nginx.conf not found - using conf.d approach instead"
                NGINX_CONFIG_DIR="/etc/nginx/conf.d"
                sudo mkdir -p "$NGINX_CONFIG_DIR"
                NGINX_CONFIG_FILE="/etc/nginx/conf.d/api.inspirtag.com.conf"
              fi
            fi

            # Copy nginx config if it exists in project
            if [ -f "api.inspirtag.com.conf" ] || [ -f "system-nginx-api-inspirtag.conf" ]; then
              CONFIG_SOURCE="api.inspirtag.com.conf"
              [ ! -f "$CONFIG_SOURCE" ] && CONFIG_SOURCE="system-nginx-api-inspirtag.conf"

              echo "   Copying nginx configuration..."
              sudo cp "$CONFIG_SOURCE" "$NGINX_CONFIG_FILE"

              # If using sites-available, create symlink
              if [ "$NGINX_CONFIG_DIR" = "/etc/nginx/sites-available" ]; then
                sudo ln -sf "$NGINX_CONFIG_FILE" /etc/nginx/sites-enabled/api.inspirtag.com.conf
              fi
            else
              # Generate nginx config dynamically
              echo "   Generating nginx configuration..."
              cat > /tmp/nginx_config_temp.conf << 'NGINX_CONFIG_EOF'
            # HTTP - redirect to HTTPS
            server {
                listen 80;
                server_name api.inspirtag.com;

                location /.well-known/acme-challenge/ {
                    root /var/www/html;
                }

                location / {
                    return 301 https://$server_name$request_uri;
                }
            }

            # HTTPS - proxy to Docker nginx
            server {
                listen 443 ssl http2;
                server_name api.inspirtag.com;

                ssl_certificate /etc/letsencrypt/live/api.inspirtag.com/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/api.inspirtag.com/privkey.pem;

                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers HIGH:!aNULL:!MD5;
                ssl_prefer_server_ciphers on;

                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                client_max_body_size 50M;

                location / {
                    proxy_pass http://127.0.0.1:8080;
                    proxy_redirect off;
                }
            }
            NGINX_CONFIG_EOF
              sudo mv /tmp/nginx_config_temp.conf "$NGINX_CONFIG_FILE"

              if [ "$NGINX_CONFIG_DIR" = "/etc/nginx/sites-available" ]; then
                sudo ln -sf "$NGINX_CONFIG_FILE" /etc/nginx/sites-enabled/api.inspirtag.com.conf
              fi
            fi

            # Generate SSL certificate if it doesn't exist
            if [ ! -f "/etc/letsencrypt/live/api.inspirtag.com/fullchain.pem" ]; then
              echo "ğŸ” Generating SSL certificate..."

              # Install certbot if not installed
              if ! command -v certbot &> /dev/null; then
                echo "   Installing certbot..."
                sudo apt update -qq
                sudo apt install -y certbot
              fi

              # Stop nginx for certificate generation
              if systemctl is-active --quiet nginx 2>/dev/null; then
                sudo systemctl stop nginx
                NGINX_STOPPED=true
              fi

              # Generate certificate
              sudo certbot certonly --standalone \
                -d api.inspirtag.com \
                --email admin@inspirtag.com \
                --agree-tos \
                --non-interactive || {
                echo "âš ï¸ SSL certificate generation failed (DNS may not be configured yet)"
                echo "   Continuing without SSL - you can generate it manually later"
              }

              # Start nginx if we stopped it
              if [ "$NGINX_STOPPED" = true ]; then
                sudo systemctl start nginx
              fi
            else
              echo "âœ… SSL certificate already exists"
            fi

            # Test nginx configuration
            echo "ğŸ§ª Testing nginx configuration..."
            if command -v nginx &> /dev/null; then
              if sudo nginx -t 2>/dev/null; then
                echo "âœ… Nginx configuration is valid"
                sudo systemctl reload nginx 2>/dev/null || sudo systemctl start nginx 2>/dev/null || true
              else
                echo "âš ï¸ Nginx configuration has errors, but continuing..."
                echo "   You may need to fix nginx config manually"
              fi
            else
              echo "âš ï¸ Nginx command not found - skipping nginx setup"
              echo "   You may need to install nginx or configure manually"
            fi

            # ============================================
            # DOCKER SETUP
            # ============================================

            # Ensure docker-compose.yml uses port 8080 (not 80)
            echo "ğŸ”§ Ensuring Docker uses port 8080..."
            if grep -q '"80:80"' docker-compose.yml; then
              echo "   Updating docker-compose.yml to use port 8080..."
              sed -i 's/"80:80"/"8080:80"/' docker-compose.yml
              sed -i 's/"443:443"/# "443:443"  # Removed - system nginx handles SSL/' docker-compose.yml
            fi

            # Update nginx config to use HTTP-only
            if grep -q "nginx-ssl.conf" docker-compose.yml; then
              echo "   Updating to use HTTP-only nginx config..."
              sed -i 's|nginx-ssl.conf|nginx.conf|' docker-compose.yml
            fi

            # Add missing .env variables if not present
            echo "ğŸ”§ Ensuring .env has required variables..."
            grep -q "AWS_URL=" .env || echo "AWS_URL=" >> .env
            grep -q "AWS_ENDPOINT=" .env || echo "AWS_ENDPOINT=" >> .env
            grep -q "AWS_USE_PATH_STYLE_ENDPOINT=" .env || echo "AWS_USE_PATH_STYLE_ENDPOINT=false" >> .env
            grep -q "APP_URL=" .env || echo "APP_URL=https://api.inspirtag.com" >> .env
            grep -q "APP_ENV=" .env || echo "APP_ENV=production" >> .env

            # Fix DB_HOST for Linux
            echo "ğŸ” Checking DB_HOST configuration..."
            if grep -q "^DB_HOST=host.docker.internal" .env; then
              echo "âš ï¸ Found host.docker.internal (doesn't work on Linux)"
              DOCKER_IP=$(ip addr show docker0 2>/dev/null | grep 'inet ' | awk '{print $2}' | cut -d/ -f1 || echo "172.17.0.1")
              sed -i "s|^DB_HOST=.*|DB_HOST=$DOCKER_IP|" .env
              echo "âœ… Updated DB_HOST to $DOCKER_IP"
            fi

            if ! grep -q "^DB_HOST=" .env; then
              DOCKER_IP=$(ip addr show docker0 2>/dev/null | grep 'inet ' | awk '{print $2}' | cut -d/ -f1 || echo "172.17.0.1")
              echo "DB_HOST=$DOCKER_IP" >> .env
              echo "âœ… Added DB_HOST=$DOCKER_IP"
            fi

            # Backup .env file
            echo "ğŸ’¾ Backing up .env file..."
            cp .env .env.backup

            # Complete shutdown - remove everything
            echo "ğŸ›‘ Stopping all containers..."
            docker-compose down --remove-orphans --timeout 10 || true

            # Force remove any stuck containers
            echo "ğŸ§¹ Cleaning up stuck containers..."
            docker ps -aq | xargs -r docker rm -f 2>/dev/null || true

            # Prune everything
            docker container prune -f
            docker network prune -f

            # Restore .env file
            echo "ğŸ“‹ Restoring .env file..."
            cp .env.backup .env

            # Always rebuild to ensure latest code
            echo "ğŸ”¨ Building containers..."
            docker-compose build --no-cache

            # Start all containers fresh
            echo "ğŸš€ Starting containers..."
            docker-compose up -d --force-recreate

            # Wait for services to be ready
            echo "â³ Waiting for services to start..."
            sleep 15

            # Check if app container is running
            echo "ğŸ” Checking app container..."
            if ! docker-compose ps app | grep -q "Up"; then
              echo "âŒ App container is not running"
              docker-compose logs app
              exit 1
            fi

            # Clear all Laravel caches
            echo "ğŸ§¹ Clearing Laravel caches..."
            docker-compose exec -T app php artisan config:clear || true
            docker-compose exec -T app php artisan route:clear || true
            docker-compose exec -T app php artisan cache:clear || true
            docker-compose exec -T app php artisan view:clear || true
            docker-compose exec -T app rm -rf bootstrap/cache/*.php || true

            # Run migrations
            echo "ğŸ—„ï¸ Running migrations..."
            docker-compose exec -T app php artisan migrate --force || {
              echo "âš ï¸ Migrations failed, continuing..."
            }

            # Cache configuration
            echo "ğŸ“¦ Caching configuration..."
            docker-compose exec -T app php artisan config:cache
            docker-compose exec -T app php artisan route:cache
            docker-compose exec -T app php artisan view:cache

            # Restart queue workers
            echo "ğŸ”„ Restarting queue workers..."
            docker-compose exec -T app php artisan queue:restart || true

            # Health check
            echo "ğŸ¥ Health check..."
            sleep 5

            # Test Docker nginx directly
            if curl -f http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… Docker nginx is healthy on port 8080"
            else
              echo "âš ï¸ Docker nginx health check failed"
              docker-compose logs --tail=50 nginx
            fi

            # Test through system nginx (if SSL is configured)
            if [ -f "/etc/letsencrypt/live/api.inspirtag.com/fullchain.pem" ]; then
              if curl -f -k https://api.inspirtag.com/health > /dev/null 2>&1; then
                echo "âœ… API is accessible via HTTPS"
              else
                echo "âš ï¸ HTTPS test failed (DNS may not be configured yet)"
              fi
            fi

            # Final container status
            echo "ğŸ“Š Final container status:"
            docker-compose ps

            echo "ğŸ‰ Deployment completed!"
            echo ""
            echo "ğŸ“‹ Summary:"
            echo "   âœ… Docker containers running on port 8080"
            echo "   âœ… System nginx configured as reverse proxy"
            if [ -f "/etc/letsencrypt/live/api.inspirtag.com/fullchain.pem" ]; then
              echo "   âœ… SSL certificate configured"
            else
              echo "   âš ï¸ SSL certificate not yet configured (run certbot manually)"
            fi
            echo "   ğŸ“ API URL: https://api.inspirtag.com"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
