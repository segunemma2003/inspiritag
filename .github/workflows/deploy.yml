name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            set -e  # Exit on any error

            # Navigate to project directory
            cd /var/www/inspirtag

            # Fix git configuration for pulls
            git config pull.rebase false

            # Stash any local changes
            echo "ğŸ“¦ Stashing local changes..."
            git stash

            # Pull latest changes
            echo "ğŸ”„ Pulling latest changes..."
            git pull origin main --no-edit || {
              echo "âš ï¸ Git pull failed, forcing reset..."
              git fetch origin
              git reset --hard origin/main
            }

            # Restore stashed changes if any
            git stash pop 2>/dev/null || true

            # Make scripts executable if they exist
            chmod +x fix_server_docker.sh 2>/dev/null || true
            chmod +x ensure_containers_running.sh 2>/dev/null || true
            chmod +x docker/entrypoint.sh 2>/dev/null || true

            # Check if Docker is running
            if ! docker info > /dev/null 2>&1; then
              echo "ğŸ³ Starting Docker..."
              sudo systemctl start docker
              sleep 5
            fi

            # Add missing .env variables if not present
            echo "ğŸ”§ Ensuring .env has required variables..."
            grep -q "AWS_URL=" .env || echo "AWS_URL=" >> .env
            grep -q "AWS_ENDPOINT=" .env || echo "AWS_ENDPOINT=" >> .env
            grep -q "AWS_USE_PATH_STYLE_ENDPOINT=" .env || echo "AWS_USE_PATH_STYLE_ENDPOINT=false" >> .env

            # Backup .env file
            echo "ğŸ’¾ Backing up .env file..."
            cp .env .env.backup

            # Complete shutdown - remove everything
            echo "ğŸ›‘ Stopping all containers..."
            docker-compose down -v --remove-orphans --timeout 10 || true

            # Force remove any stuck containers
            echo "ğŸ§¹ Cleaning up stuck containers..."
            docker ps -aq | xargs -r docker rm -f 2>/dev/null || true

            # Prune everything
            docker container prune -f
            docker network prune -f

            # Restore .env file
            echo "ğŸ“‹ Restoring .env file..."
            cp .env.backup .env

            # Rebuild only if Docker files changed
            if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -E "(Dockerfile|docker/)" > /dev/null; then
              echo "ğŸ”¨ Rebuilding containers (Docker files changed)..."
              docker-compose build --no-cache
            else
              echo "â­ï¸ Skipping rebuild (no Docker changes)"
            fi

            # Start all containers fresh
            echo "ğŸš€ Starting containers..."
            docker-compose up -d --force-recreate

            # Wait for services to be ready
            echo "â³ Waiting for services to start..."
            sleep 15

            # Check MySQL health
            echo "ğŸ” Checking MySQL..."
            for i in {1..30}; do
              if docker-compose exec -T mysql mysqladmin ping -h localhost --silent 2>/dev/null; then
                echo "âœ… MySQL is ready!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âŒ MySQL failed to start"
                docker-compose logs mysql
                exit 1
              fi
              echo "â³ Waiting for MySQL... ($i/30)"
              sleep 2
            done

            # Clear all Laravel caches
            echo "ğŸ§¹ Clearing Laravel caches..."
            docker-compose exec -T app php artisan config:clear || true
            docker-compose exec -T app php artisan route:clear || true
            docker-compose exec -T app php artisan cache:clear || true
            docker-compose exec -T app php artisan view:clear || true
            docker-compose exec -T app rm -rf bootstrap/cache/*.php || true

            # Run migrations
            echo "ğŸ—„ï¸ Running migrations..."
            docker-compose exec -T app php artisan migrate --force || {
              echo "âš ï¸ Migrations failed, continuing..."
            }

            # Cache configuration
            echo "ğŸ“¦ Caching configuration..."
            docker-compose exec -T app php artisan config:cache
            docker-compose exec -T app php artisan route:cache
            docker-compose exec -T app php artisan view:cache

            # Restart queue workers
            echo "ğŸ”„ Restarting queue workers..."
            docker-compose exec -T app php artisan queue:restart || true

            # Health check
            echo "ğŸ¥ Health check..."
            sleep 5

            if curl -f http://localhost/health > /dev/null 2>&1; then
              echo "âœ… Deployment successful!"
            else
              echo "âš ï¸ Health check failed, checking logs..."
              docker-compose ps
              docker-compose logs --tail=50 app
              echo "Continuing anyway..."
            fi

            # Test API
            echo "ğŸ§ª Testing API..."
            curl -f http://localhost/api/categories 2>/dev/null || echo "âš ï¸ API test skipped"

            # Final container status
            echo "ğŸ“Š Final container status:"
            docker-compose ps

            echo "ğŸ‰ Deployment completed!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
